{% extends "base.html" %}

{% block title %}M√©todos Congruenciales - Dashboard Estad√≠stica{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>üî¢ M√©todos Congruenciales</h2>
    </div>
    <div class="card-body">
        <p>Generadores de n√∫meros pseudoaleatorios usando diferentes m√©todos congruenciales.</p>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="parametros">Par√°metros Manuales</button>
            <button class="tab" data-tab="archivo">Subir Archivo</button>
            <button class="tab" data-tab="resultados">Resultados</button>
        </div>

        <!-- Par√°metros Manuales Tab -->
        <div id="parametros-tab" class="tab-content active">
            <form method="POST" action="{{ url_for('metodos_congruenciales') }}">
                <div class="form-group">
                    <label class="form-label">Seleccionar M√©todo:</label>
                    <select name="metodo" class="form-control form-select" id="metodoSelect" required>
                        <option value="lineal">Congruencial Lineal</option>
                        <option value="multiplicativo">Congruencial Multiplicativo</option>
                        <option value="cuadratico">Congruencial Cuadr√°tico</option>
                    </select>
                </div>

                <div class="parameters-grid">
                    <div class="parameter-group">
                        <label class="parameter-label">Semilla (X‚ÇÄ):</label>
                        <input type="number" name="semilla" class="parameter-input" value="1" min="1" required>
                    </div>
                    
                    <div class="parameter-group">
                        <label class="parameter-label">Cantidad de n√∫meros:</label>
                        <input type="number" name="cantidad" class="parameter-input" value="100" min="10" max="10000" required>
                    </div>

                    <!-- Congruencial Lineal Parameters -->
                    <div class="parameter-group metodo-param" id="param-lineal">
                        <label class="parameter-label">Multiplicador (a):</label>
                        <input type="number" name="a" class="parameter-input" value="5" required>
                    </div>
                    
                    <div class="parameter-group metodo-param" id="param-lineal">
                        <label class="parameter-label">Incremento (c):</label>
                        <input type="number" name="c" class="parameter-input" value="3" required>
                    </div>
                    
                    <div class="parameter-group metodo-param" id="param-lineal">
                        <label class="parameter-label">M√≥dulo (m):</label>
                        <input type="number" name="m" class="parameter-input" value="16" required>
                    </div>

                    <!-- Congruencial Multiplicativo Parameters -->
                    <div class="parameter-group metodo-param" id="param-multiplicativo" style="display: none;">
                        <label class="parameter-label">Multiplicador (a):</label>
                        <input type="number" name="a" class="parameter-input" value="5" required>
                    </div>
                    
                    <div class="parameter-group metodo-param" id="param-multiplicativo" style="display: none;">
                        <label class="parameter-label">M√≥dulo (m):</label>
                        <input type="number" name="m" class="parameter-input" value="16" required>
                    </div>

                    <!-- Congruencial Cuadr√°tico Parameters -->
                    <div class="parameter-group metodo-param" id="param-cuadratico" style="display: none;">
                        <label class="parameter-label">Coeficiente a:</label>
                        <input type="number" name="a" class="parameter-input" value="1" required>
                    </div>
                    
                    <div class="parameter-group metodo-param" id="param-cuadratico" style="display: none;">
                        <label class="parameter-label">Coeficiente b:</label>
                        <input type="number" name="b" class="parameter-input" value="1" required>
                    </div>
                    
                    <div class="parameter-group metodo-param" id="param-cuadratico" style="display: none;">
                        <label class="parameter-label">Coeficiente c:</label>
                        <input type="number" name="c_const" class="parameter-input" value="1" required>
                    </div>
                    
                    <div class="parameter-group metodo-param" id="param-cuadratico" style="display: none;">
                        <label class="parameter-label">M√≥dulo (m):</label>
                        <input type="number" name="m" class="parameter-input" value="65536" required>
                    </div>
                </div>

                <button type="submit" name="calcular" class="btn btn-primary btn-lg">
                    üéØ Generar N√∫meros Aleatorios
                </button>
            </form>
        </div>

        <!-- Subir Archivo Tab -->
        <div id="archivo-tab" class="tab-content">
            <form method="POST" action="{{ url_for('metodos_congruenciales') }}" enctype="multipart/form-data" class="file-upload-form">
                <div class="file-upload-area">
                    <div class="upload-icon">üìÅ</div>
                    <h4>Arrastra y suelta tu archivo aqu√≠</h4>
                    <p>o haz clic para seleccionar</p>
                    <input type="file" name="subir_archivo" class="file-input" accept=".csv,.xlsx,.txt">
                    <div class="file-label">Formatos soportados: CSV, Excel, TXT</div>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">Seleccionar m√©todo para procesar:</label>
                    <select name="metodo_archivo" class="form-control form-select" required>
                        <option value="lineal">Congruencial Lineal</option>
                        <option value="multiplicativo">Congruencial Multiplicativo</option>
                        <option value="cuadratico">Congruencial Cuadr√°tico</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-success btn-lg">
                    üì§ Subir y Procesar Archivo
                </button>
            </form>

            {% if datos_archivo %}
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h4>Vista Previa del Archivo</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    {% for col in datos_archivo[0].keys() %}
                                    <th>{{ col }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in datos_archivo %}
                                <tr>
                                    {% for value in row.values() %}
                                    <td>{{ value }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <form method="POST" action="{{ url_for('procesar_archivo_congruencial') }}">
                        <input type="hidden" name="filename" value="{{ filename }}">
                        <input type="hidden" name="metodo_archivo" value="lineal">
                        <button type="submit" class="btn btn-primary">Procesar con M√©todo Seleccionado</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Resultados Tab -->
        <div id="resultados-tab" class="tab-content">
            {% if numeros %}
            <div class="row">
                <div class="col">
                    <div class="card">
                        <div class="card-header">
                            <h4>Estad√≠sticas</h4>
                        </div>
                        <div class="card-body">
                            <div class="result-item">
                                <span>Media:</span>
                                <span class="result-value">{{ "%.6f"|format(stats.media) }}</span>
                            </div>
                            <div class="result-item">
                                <span>Desviaci√≥n:</span>
                                <span class="result-value">{{ "%.6f"|format(stats.desviacion) }}</span>
                            </div>
                            <div class="result-item">
                                <span>M√≠nimo:</span>
                                <span class="result-value">{{ "%.6f"|format(stats.minimo) }}</span>
                            </div>
                            <div class="result-item">
                                <span>M√°ximo:</span>
                                <span class="result-value">{{ "%.6f"|format(stats.maximo) }}</span>
                            </div>
                            <div class="result-item">
                                <span>Varianza:</span>
                                <span class="result-value">{{ "%.6f"|format(stats.varianza) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header">
                            <h4>Acciones</h4>
                        </div>
                        <div class="card-body">
                            <button onclick="exportarResultados()" class="btn btn-success btn-sm" style="width: 100%; margin-bottom: 0.5rem;">
                                üì• Exportar CSV
                            </button>
                            <button onclick="copiarResultados()" class="btn btn-secondary btn-sm" style="width: 100%;">
                                üìã Copiar Resultados
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-2">
                    <div class="card">
                        <div class="card-header">
                            <h4>Visualizaci√≥n</h4>
                        </div>
                        <div class="card-body">
                            {% if plot_url %}
                            <img src="data:image/png;base64,{{ plot_url }}" alt="Gr√°ficos de resultados" style="width: 100%; height: auto;">
                            {% else %}
                            <div class="chart-container">
                                <canvas id="distributionChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="sequenceChart"></canvas>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h4>N√∫meros Generados (primeros 50)</h4>
                </div>
                <div class="card-body">
                    <div class="results-container">
                        {% for numero in numeros[:50] %}
                        <div class="result-item">
                            <span>N√∫mero {{ loop.index }}</span>
                            <span class="result-value">{{ "%.6f"|format(numero) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div style="text-align: center; padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
                <h4>No hay resultados a√∫n</h4>
                <p>Genera n√∫meros aleatorios o sube un archivo para ver los resultados aqu√≠.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Documentaci√≥n -->
<div class="card">
    <div class="card-header">
        <h3>üìö Documentaci√≥n - M√©todos Congruenciales</h3>
    </div>
    <div class="card-body">
        <div class="code-block">
            <span class="code-comment"># Congruencial Lineal</span><br>
            <span class="code-keyword">X</span><span class="code-number">‚Çô‚Çä‚ÇÅ</span> = (<span class="code-keyword">a</span> * <span class="code-keyword">X‚Çô</span> + <span class="code-keyword">c</span>) <span class="code-keyword">mod</span> <span class="code-keyword">m</span><br><br>
            
            <span class="code-comment"># Congruencial Multiplicativo</span><br>
            <span class="code-keyword">X</span><span class="code-number">‚Çô‚Çä‚ÇÅ</span> = (<span class="code-keyword">a</span> * <span class="code-keyword">X‚Çô</span>) <span class="code-keyword">mod</span> <span class="code-keyword">m</span><br><br>
            
            <span class="code-comment"># Congruencial Cuadr√°tico</span><br>
            <span class="code-keyword">X</span><span class="code-number">‚Çô‚Çä‚ÇÅ</span> = (<span class="code-keyword">a</span> * <span class="code-keyword">X‚Çô¬≤</span> + <span class="code-keyword">b</span> * <span class="code-keyword">X‚Çô</span> + <span class="code-keyword">c</span>) <span class="code-keyword">mod</span> <span class="code-keyword">m</span>
        </div>

        <div class="parameters-grid" style="margin-top: 1.5rem;">
            <div class="parameter-group">
                <h5>Par√°metros Recomendados</h5>
                <div class="result-item">
                    <span>Lineal (Park-Miller):</span>
                    <span class="result-value">a=16807, m=2¬≥¬π-1</span>
                </div>
                <div class="result-item">
                    <span>Multiplicativo:</span>
                    <span class="result-value">a=397204094, m=2¬≥¬π-1</span>
                </div>
            </div>
            <div class="parameter-group">
                <h5>Propiedades</h5>
                <ul>
                    <li>Per√≠odo m√°ximo: m (lineal)</li>
                    <li>Per√≠odo m√°ximo: m-1 (multiplicativo)</li>
                    <li>Distribuci√≥n uniforme [0,1)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Manejar cambio de m√©todo
document.getElementById('metodoSelect').addEventListener('change', function() {
    const metodo = this.value;
    
    // Ocultar todos los par√°metros
    document.querySelectorAll('.metodo-param').forEach(param => {
        param.style.display = 'none';
    });
    
    // Mostrar par√°metros del m√©todo seleccionado
    document.querySelectorAll('#param-' + metodo).forEach(param => {
        param.style.display = 'block';
    });
});

// Inicializar par√°metros visibles
document.addEventListener('DOMContentLoaded', function() {
    const metodoSelect = document.getElementById('metodoSelect');
    if (metodoSelect) {
        metodoSelect.dispatchEvent(new Event('change'));
    }

    // Inicializar tabs
    if (window.dashboard) {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                window.dashboard.switchTab(tabName);
            });
        });
    }

    // Mostrar gr√°ficos de ejemplo si no hay resultados
    {% if not numeros %}
    mostrarGraficosEjemplo();
    {% endif %}
});

function exportarResultados() {
    // Implementar exportaci√≥n de resultados
    if (window.dashboard) {
        window.dashboard.showAlert('Funcionalidad de exportaci√≥n en desarrollo', 'info');
    }
}

function copiarResultados() {
    // Implementar copia de resultados
    if (window.dashboard) {
        window.dashboard.showAlert('Funcionalidad de copia en desarrollo', 'info');
    }
}

function mostrarGraficosEjemplo() {
    // Gr√°fico de distribuci√≥n de ejemplo
    const distCtx = document.getElementById('distributionChart');
    const seqCtx = document.getElementById('sequenceChart');
    
    if (distCtx) {
        new Chart(distCtx, {
            type: 'bar',
            data: {
                labels: ['0-0.1', '0.1-0.2', '0.2-0.3', '0.3-0.4', '0.4-0.5', '0.5-0.6', '0.6-0.7', '0.7-0.8', '0.8-0.9', '0.9-1.0'],
                datasets: [{
                    label: 'Distribuci√≥n de Frecuencias',
                    data: [95, 102, 98, 105, 97, 103, 96, 101, 99, 104],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribuci√≥n de Valores Generados'
                    }
                }
            }
        });
    }

    if (seqCtx) {
        new Chart(seqCtx, {
            type: 'line',
            data: {
                labels: Array.from({length: 50}, (_, i) => i + 1),
                datasets: [{
                    label: 'Secuencia de N√∫meros',
                    data: Array.from({length: 50}, () => Math.random()),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Secuencia de Valores'
                    }
                }
            }
        });
    }
}
</script>
{% endblock %}